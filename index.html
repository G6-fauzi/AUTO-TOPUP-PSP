<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controller Top Up Ukhro (Gemini 2.5 AI)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; }
        .status-pending { @apply text-yellow-600 bg-yellow-100; }
        .status-processing { @apply text-blue-600 bg-blue-100 animate-pulse; }
        .status-success { @apply text-green-600 bg-green-100; }
        .status-error { @apply text-red-600 bg-red-100; }
        
        /* Animasi Loading Scan */
        .scan-loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="container mx-auto p-6 max-w-4xl">
        
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">ü§ñ Controller Top Up Ukhro</h1>
            <p class="text-gray-600 text-sm">Versi 2.5: Menggunakan <b>Gemini 2.5 Flash</b> untuk Akurasi Tinggi</p>
        </div>

        <!-- Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block font-bold mb-1 text-gray-700">Gemini API Key <span class="text-red-500">*</span></label>
                    <input type="password" v-model="apiKey" class="w-full border p-2 rounded focus:ring focus:ring-blue-300 bg-gray-50" placeholder="Tempel API Key Gemini di sini...">
                </div>

                <!-- Bagian Upload & Scan -->
                <div class="md:col-span-2 bg-blue-50 p-4 rounded border border-blue-100">
                    <label class="block font-bold mb-2 text-blue-800">1. Upload Foto Tabel</label>
                    <div class="flex gap-2">
                        <input type="file" ref="fileInput" @change="handleFileSelect" accept="image/*" class="flex-grow border p-2 rounded bg-white">
                        <button 
                            @click="triggerScan" 
                            :disabled="isAnalyzing || !apiKey"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold disabled:bg-gray-400 flex items-center gap-2"
                        >
                            <div v-if="isAnalyzing" class="scan-loader"></div>
                            {{ isAnalyzing ? 'Sedang Baca...' : 'üîç SCAN FOTO (v2.5)' }}
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">*Pilih foto lalu klik SCAN FOTO jika data tidak muncul otomatis.</p>
                </div>

                <div>
                    <label class="block font-bold mb-1">2. Nominal (Rp) <span class="text-red-500">*</span></label>
                    <input type="number" v-model="config.nominal" class="w-full border p-2 rounded focus:ring focus:ring-blue-300" placeholder="5000">
                </div>
                <div>
                    <label class="block font-bold mb-1">3. Keterangan <span class="text-red-500">*</span></label>
                    <input type="text" v-model="config.note" class="w-full border p-2 rounded focus:ring focus:ring-blue-300" placeholder="SPP/Tabungan">
                </div>
            </div>
            
            <!-- Error Message Box -->
            <div v-if="errorMessage" class="mt-4 p-3 bg-red-100 text-red-700 rounded border border-red-200 text-sm font-mono">
                ‚ùå {{ errorMessage }}
            </div>
        </div>

        <!-- Controls (Tombol Mulai) -->
        <div class="flex flex-col md:flex-row gap-4 mb-6 items-center bg-gray-100 p-4 rounded-lg sticky top-0 z-10 shadow-sm border">
            <button 
                @click="startQueue" 
                :disabled="!canStart" 
                :class="[
                    'px-6 py-3 rounded-lg font-bold shadow transition-colors flex-grow md:flex-grow-0 text-left',
                    canStart ? 'bg-green-600 hover:bg-green-700 text-white cursor-pointer' : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                ]"
            >
                <span v-if="isRunning">üîÑ Sedang Berjalan...</span>
                <span v-else-if="students.length === 0">‚ö†Ô∏è Data Kosong (Scan Foto Dulu)</span>
                <span v-else-if="!config.nominal">‚ö†Ô∏è Isi Nominal Dulu</span>
                <span v-else>‚ñ∂Ô∏è MULAI EKSEKUSI ({{ students.length }} Data)</span>
            </button>
            
            <button 
                @click="stopQueue" 
                v-if="isRunning" 
                class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold shadow"
            >
                ‚èπÔ∏è STOP
            </button>

            <div class="flex-grow text-right self-center text-gray-700 font-mono font-medium">
                {{ progressText }}
            </div>
        </div>

        <!-- Data Table (Preview Data) -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="flex justify-between items-center p-3 bg-gray-100 border-b">
                <div class="font-bold text-gray-700">Preview Data Siswa ({{ students.length }} Baris)</div>
                <button v-if="students.length > 0" @click="students = []" class="text-xs text-red-500 hover:underline">Hapus Semua</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="p-3 text-left w-12">No</th>
                            <th class="p-3 text-left w-24">NIS</th>
                            <th class="p-3 text-left">Nama Siswa (Wajib Cek)</th>
                            <th class="p-3 text-left">Nama Ayah (Wajib Cek)</th>
                            <th class="p-3 text-left w-28">Status</th>
                            <th class="p-3 w-10">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- State Kosong -->
                        <tr v-if="students.length === 0">
                            <td colspan="6" class="p-8 text-center text-gray-500">
                                <div class="text-5xl mb-4">üìÑ</div>
                                <p class="font-bold">Belum ada data yang discan.</p>
                                <p class="text-sm mt-1">1. Masukkan API Key.<br>2. Upload Foto.<br>3. Klik tombol <b>SCAN FOTO</b> biru di atas.</p>
                            </td>
                        </tr>

                        <!-- State Ada Data -->
                        <tr v-for="(s, index) in students" :key="index" class="border-b hover:bg-gray-50 transition-colors">
                            <td class="p-2 text-center">{{ index + 1 }}</td>
                            <td class="p-2"><input v-model="s.nis" class="w-full bg-transparent border border-transparent hover:border-gray-300 focus:border-blue-500 rounded px-1"></td>
                            <td class="p-2"><input v-model="s.nama" class="w-full font-bold bg-transparent border border-transparent hover:border-gray-300 focus:border-blue-500 rounded px-1"></td>
                            <td class="p-2"><input v-model="s.nama_ayah" class="w-full bg-transparent border border-transparent hover:border-gray-300 focus:border-blue-500 rounded px-1"></td>
                            <td class="p-2">
                                <span :class="'px-2 py-1 rounded text-xs font-bold inline-block w-full text-center status-' + s.status">
                                    {{ s.status === 'pending' ? 'MENUNGGU' : s.status.toUpperCase() }}
                                </span>
                            </td>
                            <td class="p-2 text-center">
                                <button @click="removeStudent(index)" class="text-red-500 hover:text-red-700 font-bold">√ó</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const apiKey = ref(localStorage.getItem('GEMINI_API_KEY') || '');
                const config = ref({ nominal: '', note: '' });
                const students = ref([]);
                const isAnalyzing = ref(false);
                const isRunning = ref(false);
                const currentIndex = ref(0);
                const errorMessage = ref('');
                const fileInput = ref(null);
                let workerWindow = null;

                // Simpan API Key biar gak capek ngetik ulang
                const saveKey = () => localStorage.setItem('GEMINI_API_KEY', apiKey.value);

                // Event saat pilih file
                const handleFileSelect = () => {
                    // Reset error saat pilih file baru
                    errorMessage.value = '';
                    // Opsional: Langsung scan jika key ada
                    if (apiKey.value) {
                        triggerScan();
                    }
                };

                // Fungsi Scan (Bisa dipanggil manual tombol)
                const triggerScan = async () => {
                    const files = fileInput.value.files;
                    if (files.length === 0) {
                        alert("‚ö†Ô∏è Pilih foto tabel terlebih dahulu!");
                        return;
                    }
                    if (!apiKey.value) {
                        alert("‚ö†Ô∏è Masukkan API Key Gemini!");
                        return;
                    }

                    saveKey();
                    isAnalyzing.value = true;
                    errorMessage.value = '';
                    
                    try {
                        const file = files[0];
                        // Convert File to Base64
                        const base64Data = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(file);
                        });

                        const genAI = new GoogleGenerativeAI(apiKey.value);
                        
                        // --- UPDATE: Menggunakan Model Gemini 2.5 Flash ---
                        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

                        // Prompt yang disesuaikan dengan gambar user (Multi tabel kelompok)
                        const prompt = `
                            Kamu adalah asisten entri data. Tugasmu adalah mengekstrak data siswa dari foto tabel kertas ini ke dalam format JSON.
                            
                            INSTRUKSI KHUSUS:
                            1. Foto ini mungkin berisi beberapa tabel terpisah (misal: "KELOMPOK : 7", "KELOMPOK : 8"). Gabungkan semua data siswa menjadi satu list flat.
                            2. Abaikan baris header (No, Nis, Nama, Nama Ayah, dsb).
                            3. Abaikan baris judul kelompok (misal "KELOMPOK : 7").
                            4. Abaikan tulisan tangan atau total di bagian bawah kertas.
                            5. Fokus pada kolom: NIS, Nama, Nama Ayah.
                            6. Perbaiki typo OCR yang umum (misal 'l' jadi '1' di NIS, atau salah spasi).
                            
                            FORMAT OUTPUT (Wajib JSON Array Murni tanpa Markdown):
                            [
                              { "nis": "12345", "nama": "Budi Santoso", "nama_ayah": "Suharto" },
                              { "nis": "67890", "nama": "Siti Aminah", "nama_ayah": "Jokowi" }
                            ]
                        `;

                        const result = await model.generateContent([
                            prompt,
                            { inlineData: { data: base64Data, mimeType: file.type } }
                        ]);
                        
                        const text = result.response.text();
                        console.log("Raw Response:", text); // Debugging

                        // Bersihkan markdown block ```json ... ```
                        const cleanedText = text.replace(/```json|```/g, '').trim();
                        
                        try {
                            const parsedData = JSON.parse(cleanedText);
                            if (Array.isArray(parsedData) && parsedData.length > 0) {
                                // Tambahkan status pending
                                students.value = parsedData.map(s => ({
                                    nis: s.nis || "",
                                    nama: s.nama || "",
                                    nama_ayah: s.nama_ayah || "",
                                    status: 'pending'
                                }));
                            } else {
                                throw new Error("Format JSON valid tapi kosong atau bukan array.");
                            }
                        } catch (parseError) {
                            console.error("Parse Error:", parseError);
                            throw new Error("Gagal membaca struktur data dari respon AI. Coba foto ulang dengan pencahayaan lebih baik.");
                        }

                    } catch (error) {
                        errorMessage.value = "Gagal Scan (Gemini 2.5): " + error.message;
                        console.error(error);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const removeStudent = (index) => {
                    students.value.splice(index, 1);
                };

                // Validasi Tombol Start
                const canStart = computed(() => {
                    return students.value.length > 0 && 
                           config.value.nominal && 
                           !isRunning.value;
                });

                // 2. Queue Logic
                const startQueue = () => {
                    if (!canStart.value) return;
                    isRunning.value = true;
                    processNext();
                };

                const stopQueue = () => {
                    isRunning.value = false;
                    if (workerWindow) workerWindow.close();
                };

                const processNext = () => {
                    if (!isRunning.value) return;

                    // Cari siswa pending
                    const index = students.value.findIndex(s => s.status === 'pending');
                    if (index === -1) {
                        alert("‚úÖ Semua data selesai diproses!");
                        isRunning.value = false;
                        return;
                    }

                    currentIndex.value = index;
                    const student = students.value[index];
                    student.status = 'processing';

                    // Payload
                    const payload = {
                        student: student,
                        config: config.value
                    };
                    
                    const targetUrl = `https://psp-admin.teknologikartu.com/main/payment/user-balance#bot_job=${encodeURIComponent(JSON.stringify(payload))}`;
                    
                    if (workerWindow && !workerWindow.closed) {
                        workerWindow.location.href = targetUrl;
                    } else {
                        workerWindow = window.open(targetUrl, 'ukhro_worker_tab');
                    }
                };

                // 3. Listener Komunikasi
                window.addEventListener('message', (event) => {
                    const data = event.data;
                    if (data.type === 'UKHRO_BOT_REPORT') {
                        const idx = currentIndex.value;
                        if (data.status === 'success') {
                            students.value[idx].status = 'success';
                        } else {
                            students.value[idx].status = 'error';
                            console.error("Worker Error:", data.message);
                        }
                        // Lanjut next
                        setTimeout(() => processNext(), 1500);
                    }
                });

                const progressText = computed(() => {
                    if (students.value.length === 0) return "Siap";
                    const done = students.value.filter(s => s.status === 'success' || s.status === 'error').length;
                    return `${done} / ${students.value.length} Selesai`;
                });

                return {
                    apiKey, config, students, isAnalyzing, isRunning, errorMessage, fileInput,
                    handleFileSelect, triggerScan, removeStudent, startQueue, stopQueue, progressText, canStart
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
